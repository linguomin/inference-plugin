"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var senseInference=function(){function t(e){_classCallCheck(this,t),this.id=e,this.container=document.getElementById(this.id),this.scale=null,this.image={},this.canvas={},this.senseImage={position:[]},this.detection=null,this.classification=[],this.segmentation=null,this.detectionStyle={lineWidth:1,borderColor:"red",background:"transparent",textBackground:"red",show:!0,fontFamily:"微软雅黑",fontSize:14,color:"#fff"},this.classificationStyle={lineWidth:1,borderColor:"blue",textBackground:"blue",fontFamily:"微软雅黑",fontSize:20,color:"#fff"},this.segmentationStyle={}}return _createClass(t,[{key:"init",value:function(e){var t=this;this.image.url=e,this.canvas.dom=document.createElement("canvas"),this.canvas.dom.setAttribute("id","senseCanvas"),this.container.append(this.canvas.dom),this.canvas.dom.width=this.container.clientWidth,this.canvas.dom.height=this.container.clientHeight,this.canvas.aspectRatio=this.canvas.dom.width/this.canvas.dom.height,this.canvas.ctx=this.canvas.dom.getContext("2d");var i=new Image;i.src=this.image.url,i.onload=function(){t.image.width?i.width=t.image.width:t.image.width=i.width,t.image.height?i.height=t.image.height:t.image.height=i.height,t.image.aspectRatio=t.image.width/t.image.height,t.image.aspectRatio>t.canvas.aspectRatio?(t.senseImage.width=t.canvas.dom.width,t.senseImage.height=t.canvas.dom.width/t.image.aspectRatio):(t.senseImage.width=t.canvas.dom.height*t.image.aspectRatio,t.senseImage.height=t.canvas.dom.height),t.canvas.dom.width>t.senseImage.width&&(t.senseImage.position[0]=(t.canvas.dom.width-t.senseImage.width)/2,t.senseImage.position[1]=0),t.canvas.dom.height>t.senseImage.height&&(t.senseImage.position[0]=0,t.senseImage.position[1]=(t.canvas.dom.height-t.senseImage.height)/2),t.scale=t.image.width/t.senseImage.width,t.canvas.ctx.drawImage(i,t.senseImage.position[0],t.senseImage.position[1],t.senseImage.width,t.senseImage.height),t.detection&&t.loadDetection(),t.classification&&t.loadClassification(),t.segmentation&&t.loadSegmentation().then(function(e){i.src=e,i.onload=function(){t.canvas.ctx.drawImage(i,t.senseImage.position[0],t.senseImage.position[1],t.senseImage.width,t.senseImage.height)}})}}},{key:"loadDetection",value:function(){var e=!0,t=!1,i=void 0;try{for(var n=this.detection[Symbol.iterator]();!(e=(a=n.next()).done);e=!0){var a=a.value;a.senseBbox.left=a.bbox.left/this.scale+this.senseImage.position[0],a.senseBbox.top=a.bbox.top/this.scale+this.senseImage.position[1],a.senseBbox.width=a.bbox.width/this.scale,a.senseBbox.height=a.bbox.height/this.scale,this.drawRect(a.senseBbox.left,a.senseBbox.top,a.senseBbox.width,a.senseBbox.height,this.detectionStyle),this.detectionStyle.show&&this.drawText(a.label,[a.senseBbox.left,a.senseBbox.top],this.detectionStyle)}}catch(e){t=!0,i=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw i}}}},{key:"loadClassification",value:function(){var i=this;this.classification.forEach(function(e,t){i.drawText(e.label,[i.senseImage.position[0]+20,i.senseImage.position[1]+40*(t+1)],i.classificationStyle)})}},{key:"loadSegmentation",value:function(){var o=this;return new Promise(function(e){var t=document.createElement("canvas");t.width=o.segmentation.length,t.height=o.segmentation[0].length,t.setAttribute("style","visibility: hidden"),document.body.append(t);var i=t.getContext("2d");i.lineWidth=1;for(var n=0;n<=o.segmentation.length;n++)for(var a=0;a<=o.segmentation[0].length;a++)o.segmentation[n]&&0!==o.segmentation[n][a]&&(0==a?(i.beginPath(),i.strokeStyle=o.segmentationStyle[o.segmentation[n][a]],i.moveTo(n,a)):o.segmentation[n][a]==o.segmentation[n][a-1]?i.lineTo(n,a):(i.stroke(),i.beginPath(),i.strokeStyle=o.segmentationStyle[o.segmentation[n][a]],i.moveTo(n,a)));var s=t.toDataURL("image/png");document.body.removeChild(t),e(s)})}},{key:"drawRect",value:function(e,t,i,n,a){this.canvas.ctx.strokeStyle=a.borderColor,this.canvas.ctx.lineWidth=a.lineWidth,this.canvas.ctx.fillStyle=a.background,this.canvas.ctx.beginPath(),this.canvas.ctx.rect(e,t,i,n),this.canvas.ctx.stroke(),this.canvas.ctx.fill()}},{key:"drawText",value:function(e,t,i){var n;e.length&&(this.canvas.ctx.font=i.fontSize+"px "+i.fontFamily,n=this.canvas.ctx.measureText(e).width+6,this.drawRect(t[0],t[1]-i.fontSize-5,n,i.fontSize+4,{borderColor:i.borderColor,lineWidth:i.lineWidth,background:i.textBackground}),this.canvas.ctx.beginPath(),this.canvas.ctx.fillStyle=i.color,this.canvas.ctx.textAlign="left",this.canvas.ctx.textBaseline="bottom",this.canvas.ctx.fillText(e,t[0]+3,t[1]-2))}},{key:"addDetection",value:function(e){var t=!0,i=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(t=(a=s.next()).done);t=!0)a.value.senseBbox={left:null,top:null,width:null,height:null}}catch(e){i=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw n}}this.detection=e}},{key:"addClassification",value:function(e){var t=!0,i=!1,n=void 0;try{for(var a=e[Symbol.iterator]();!(t=(s=a.next()).done);t=!0){var s,o=s.value;o.classes&&(s=Object.values(o.classes),o=Math.max.apply(null,s),o=s.indexOf(o),this.classification.push({label:o.toString()}))}}catch(e){i=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(i)throw n}}}},{key:"addSegmentation",value:function(e){if(this.segmentation=e,"{}"===JSON.stringify(this.segmentationStyle))for(var t=0;t<=100;t++)this.segmentationStyle[t]=this.getRandomColor()}},{key:"addSegmentationColor",value:function(e){this.segmentationStyle=e}},{key:"setImageSize",value:function(e){var t=e.width,e=e.height;this.image.width=t,this.image.height=e}},{key:"getRandomColor",value:function(){return"#"+Math.random().toString(16).slice(2,8)}}]),t}();exports.default=senseInference;