"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var senseInference=function(){function t(e){_classCallCheck(this,t),this.id=e,this.container=document.getElementById(this.id),this.scale=null,this.image={},this.canvas={},this.senseImage={position:[]},this.detection=null,this.classification=null,this.segmentation=null,this.detectionStyle={lineWidth:1,borderColor:"red",background:"transparent",textBackground:"red",show:!0,fontFamily:"微软雅黑",fontSize:14,color:"#fff"},this.classificationStyle={lineWidth:1,borderColor:"blue",textBackground:"blue",fontFamily:"微软雅黑",fontSize:20,color:"#fff"},this.segmentationStyle={}}return _createClass(t,[{key:"init",value:function(e){var t=this;this.image.url=e,this.canvas.dom=document.createElement("canvas"),this.canvas.dom.setAttribute("id","senseCanvas"),this.container.append(this.canvas.dom),this.canvas.dom.width=this.container.clientWidth,this.canvas.dom.height=this.container.clientHeight,this.canvas.aspectRatio=this.canvas.dom.width/this.canvas.dom.height,this.canvas.ctx=this.canvas.dom.getContext("2d");var i=new Image;i.src=this.image.url,i.onload=function(){t.image.width=i.width,t.image.height=i.height,t.image.aspectRatio=t.image.width/t.image.height,t.image.aspectRatio>t.canvas.aspectRatio?(t.senseImage.width=t.canvas.dom.width,t.senseImage.height=t.canvas.dom.width/t.image.aspectRatio):(t.senseImage.width=t.canvas.dom.height*t.image.aspectRatio,t.senseImage.height=t.canvas.dom.height),t.canvas.dom.width>t.senseImage.width&&(t.senseImage.position[0]=(t.canvas.dom.width-t.senseImage.width)/2,t.senseImage.position[1]=0),t.canvas.dom.height>t.senseImage.height&&(t.senseImage.position[0]=0,t.senseImage.position[1]=(t.canvas.dom.height-t.senseImage.height)/2),t.scale=t.image.width/t.senseImage.width,t.canvas.ctx.drawImage(i,t.senseImage.position[0],t.senseImage.position[1],t.senseImage.width,t.senseImage.height),t.detection&&t.loadDetection(),t.classification&&t.loadClassification(),t.segmentation&&t.loadSegmentation().then(function(e){i.src=e,i.onload=function(){t.canvas.ctx.drawImage(i,t.senseImage.position[0],t.senseImage.position[1],t.senseImage.width,t.senseImage.height)}})}}},{key:"loadDetection",value:function(){var e=!0,t=!1,i=void 0;try{for(var n=this.detection[Symbol.iterator]();!(e=(a=n.next()).done);e=!0){var a=a.value;a.senseBbox.left=a.bbox.left/this.scale+this.senseImage.position[0],a.senseBbox.top=a.bbox.top/this.scale+this.senseImage.position[1],a.senseBbox.width=a.bbox.width/this.scale,a.senseBbox.height=a.bbox.height/this.scale,this.drawRect(a.senseBbox.left,a.senseBbox.top,a.senseBbox.width,a.senseBbox.height,this.detectionStyle),this.detectionStyle.show&&this.drawText(a.label,[a.senseBbox.left,a.senseBbox.top],this.detectionStyle)}}catch(e){t=!0,i=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw i}}}},{key:"loadClassification",value:function(){this.drawText(this.classification.label,[this.senseImage.position[0]+20,this.senseImage.position[1]+40],this.classificationStyle)}},{key:"loadSegmentation",value:function(){var h=this;return new Promise(function(a){var s=document.createElement("canvas"),o=new Image;o.src=h.image.url,o.onload=function(){s.width=o.width,s.height=o.height,s.setAttribute("style","visibility: hidden"),document.body.append(s);var e=s.getContext("2d");e.lineWidth=1;for(var t=0;t<=h.segmentation.length;t++)for(var i=0;i<=h.segmentation[0].length;i++)h.segmentation[t]&&0!==h.segmentation[t][i]&&(0==i?(e.beginPath(),e.strokeStyle=h.segmentationStyle[h.segmentation[t][i]],e.moveTo(t,i)):h.segmentation[t][i]==h.segmentation[t][i-1]?e.lineTo(t,i):(e.stroke(),e.beginPath(),e.strokeStyle=h.segmentationStyle[h.segmentation[t][i]],e.moveTo(t,i)));var n=s.toDataURL("image/png");document.body.removeChild(s),a(n)}})}},{key:"drawRect",value:function(e,t,i,n,a){this.canvas.ctx.strokeStyle=a.borderColor,this.canvas.ctx.lineWidth=a.lineWidth,this.canvas.ctx.fillStyle=a.background,this.canvas.ctx.beginPath(),this.canvas.ctx.rect(e,t,i,n),this.canvas.ctx.stroke(),this.canvas.ctx.fill()}},{key:"drawText",value:function(e,t,i){var n;e.length&&(this.canvas.ctx.font=i.fontSize+"px "+i.fontFamily,n=this.canvas.ctx.measureText(e).width+6,this.drawRect(t[0],t[1]-i.fontSize-5,n,i.fontSize+4,{borderColor:i.borderColor,lineWidth:i.lineWidth,background:i.textBackground}),this.canvas.ctx.beginPath(),this.canvas.ctx.fillStyle=i.color,this.canvas.ctx.textAlign="left",this.canvas.ctx.textBaseline="bottom",this.canvas.ctx.fillText(e,t[0]+3,t[1]-2))}},{key:"addDetection",value:function(e){var t=!0,i=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(t=(a=s.next()).done);t=!0)a.value.senseBbox={left:null,top:null,width:null,height:null}}catch(e){i=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw n}}this.detection=e}},{key:"addClassification",value:function(e){this.classification=e}},{key:"addSegmentation",value:function(e){if(this.segmentation=e,"{}"===JSON.stringify(this.segmentationStyle))for(var t=0;t<=100;t++)this.segmentationStyle[t]=this.getRandomColor()}},{key:"addSegmentationColor",value:function(e){this.segmentationStyle=e}},{key:"getRandomColor",value:function(){return"#"+Math.random().toString(16).slice(2,8)}}]),t}();exports.default=senseInference;