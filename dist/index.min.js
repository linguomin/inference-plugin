"use strict";var _createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var senseInference=function(){function e(t){_classCallCheck(this,e),this.id=t,this.container=document.getElementById(this.id),this.scale=null,this.image={},this.canvas={},this.senseImage={position:[]},this.detection=null,this.classification=null,this.segmentation=null,this.detectionStyle={lineWidth:1,borderColor:"red",background:"transparent",textBackground:"red",show:!0,fontFamily:"微软雅黑",fontSize:14,color:"#fff"},this.classificationStyle={lineWidth:1,borderColor:"blue",textBackground:"blue",fontFamily:"微软雅黑",fontSize:20,color:"#fff"},this.segmentationStyle={}}return _createClass(e,[{key:"init",value:function(t){var e=this;this.image.url=t,this.canvas.dom=document.createElement("canvas"),this.canvas.dom.setAttribute("id","senseCanvas"),this.container.append(this.canvas.dom),this.canvas.dom.width=this.container.clientWidth,this.canvas.dom.height=this.container.clientHeight,this.canvas.aspectRatio=this.canvas.dom.width/this.canvas.dom.height,this.canvas.ctx=this.canvas.dom.getContext("2d");var i=new Image;i.src=this.image.url,i.onload=function(){e.image.width=i.width,e.image.height=i.height,e.image.aspectRatio=e.image.width/e.image.height,e.image.aspectRatio>e.canvas.aspectRatio?(e.senseImage.width=e.canvas.dom.width,e.senseImage.height=e.canvas.dom.width/e.image.aspectRatio):(e.senseImage.width=e.canvas.dom.height*e.image.aspectRatio,e.senseImage.height=e.canvas.dom.height),e.canvas.dom.width>e.senseImage.width&&(e.senseImage.position[0]=(e.canvas.dom.width-e.senseImage.width)/2,e.senseImage.position[1]=0),e.canvas.dom.height>e.senseImage.height&&(e.senseImage.position[0]=0,e.senseImage.position[1]=(e.canvas.dom.height-e.senseImage.height)/2),e.scale=e.image.width/e.senseImage.width,e.canvas.ctx.drawImage(i,e.senseImage.position[0],e.senseImage.position[1],e.senseImage.width,e.senseImage.height),e.detection&&e.loadDetection(),e.classification&&e.loadClassification(),e.segmentation&&e.loadSegmentation().then(function(t){i.src=t,i.onload=function(){e.canvas.ctx.drawImage(i,e.senseImage.position[0],e.senseImage.position[1],e.senseImage.width,e.senseImage.height)}})}}},{key:"loadDetection",value:function(){var t=!0,e=!1,i=void 0;try{for(var n=this.detection[Symbol.iterator]();!(t=(a=n.next()).done);t=!0){var a=a.value;a.senseBbox.left=a.bbox.left/this.scale+this.senseImage.position[0],a.senseBbox.top=a.bbox.top/this.scale+this.senseImage.position[1],a.senseBbox.width=a.bbox.width/this.scale,a.senseBbox.height=a.bbox.height/this.scale,this.drawRect(a.senseBbox.left,a.senseBbox.top,a.senseBbox.width,a.senseBbox.height,this.detectionStyle),this.detectionStyle.show&&this.drawText(a.label,[a.senseBbox.left,a.senseBbox.top],this.detectionStyle)}}catch(t){e=!0,i=t}finally{try{!t&&n.return&&n.return()}finally{if(e)throw i}}}},{key:"loadClassification",value:function(){this.drawText(this.classification.label,[this.senseImage.position[0]+20,this.senseImage.position[1]+40],this.classificationStyle)}},{key:"loadSegmentation",value:function(){var h=this;return new Promise(function(a){var s=document.createElement("canvas"),o=new Image;o.src=h.image.url,o.onload=function(){s.width=o.width,s.height=o.height,s.setAttribute("style","visibility: hidden"),document.body.append(s);var t=s.getContext("2d");t.lineWidth=1;for(var e=0;e<=h.segmentation.length;e++)for(var i=0;i<=h.segmentation[0].length;i++)h.segmentation[e]&&0!==h.segmentation[e][i]&&(0==i?(t.beginPath(),t.strokeStyle=h.segmentationStyle[h.segmentation[e][i]],t.moveTo(e,i)):h.segmentation[e][i]==h.segmentation[e][i-1]?t.lineTo(e,i):(t.stroke(),t.beginPath(),t.strokeStyle=h.segmentationStyle[h.segmentation[e][i]],t.moveTo(e,i)));var n=s.toDataURL("image/png");document.body.removeChild(s),a(n)}})}},{key:"drawRect",value:function(t,e,i,n,a){this.canvas.ctx.strokeStyle=a.borderColor,this.canvas.ctx.lineWidth=a.lineWidth,this.canvas.ctx.fillStyle=a.background,this.canvas.ctx.beginPath(),this.canvas.ctx.rect(t,e,i,n),this.canvas.ctx.stroke(),this.canvas.ctx.fill()}},{key:"drawText",value:function(t,e,i){var n;t.length&&(this.canvas.ctx.font=i.fontSize+"px "+i.fontFamily,n=this.canvas.ctx.measureText(t).width+6,this.drawRect(e[0],e[1]-i.fontSize-5,n,i.fontSize+4,{borderColor:i.borderColor,lineWidth:i.lineWidth,background:i.textBackground}),this.canvas.ctx.beginPath(),this.canvas.ctx.fillStyle=i.color,this.canvas.ctx.textAlign="left",this.canvas.ctx.textBaseline="bottom",this.canvas.ctx.fillText(t,e[0]+3,e[1]-2))}},{key:"addDetection",value:function(t){var e=!0,i=!1,n=void 0;try{for(var a,s=t[Symbol.iterator]();!(e=(a=s.next()).done);e=!0)a.value.senseBbox={left:null,top:null,width:null,height:null}}catch(t){i=!0,n=t}finally{try{!e&&s.return&&s.return()}finally{if(i)throw n}}this.detection=t}},{key:"addClassification",value:function(t){this.classification=t}},{key:"addSegmentation",value:function(t){if(this.segmentation=t,"{}"===JSON.stringify(this.segmentationStyle))for(var e=0;e<=100;e++)this.segmentationStyle[e]=this.getRandomColor()}},{key:"addSegmentationColor",value:function(t){this.segmentationStyle=t}},{key:"getRandomColor",value:function(){return"#"+Math.random().toString(16).slice(2,8)}}]),e}();